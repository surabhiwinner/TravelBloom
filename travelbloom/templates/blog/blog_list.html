{% extends 'base.html' %}
{% load dict_extras split_filters %}

{% block section %}
<div class="container my-5">
  <h2 class="text-primary mb-4">üåç Travel Blogs</h2>

  {% if user.is_authenticated %}
  <div class="row mb-5">
    <div class="mx-auto col-md-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3 text-center text-primary">‚úçÔ∏è Share Your Travel Story</h5>

          {% if form.errors %}
          <div class="alert alert-danger">
            <strong>There were errors in your submission:</strong>
            <ul>
              {% for field in form %}
                {% for error in field.errors %}
                  <li>{{ field.label }}: {{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" action="{% url 'blog-list' %}">
            {% csrf_token %}
            <div class="mb-3">
              {{ form.title.label_tag }}
              {{ form.title }}
              <small class="form-text text-muted">Optional ‚Äî will be auto-generated from the image if left blank.</small>
            </div>
            <div class="mb-3">
              {{ form.content.label_tag }}
              {{ form.content }}
            </div>
            <div class="mb-3">
              {{ form.image.label_tag }}
              {{ form.image }}
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-success w-100">Post Blog</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% if blogs %}
  <div class="row">
    {% for blog in blogs %}
    <div class="col-md-6 mb-4">
      <div class="card h-100 shadow-sm border-0">
        {% if blog.image %}
        <img src="{{ blog.image.url }}" class="card-img-top" style="max-height: 300px; object-fit: cover;" alt="{{ blog.caption|default:blog.title }}">
        {% endif %}

        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="card-title mb-0">{{ blog.title }}</h5>

            {% if user.is_authenticated and user.profile == blog.author %}
            <div class="dropdown text-end">
              <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                ‚ãÆ
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li>
                  <form method="post" action="{% url 'delete-blog-post' blog.id %}">
                    {% csrf_token %}
                    <button type="submit" class="dropdown-item text-danger">üóëÔ∏è Delete Post</button>
                  </form>
                </li>
              </ul>
            </div>
            {% endif %}
          </div>

          <p class="text-muted small mb-2">
            By {{ blog.author }} ‚Ä¢ {{ blog.created_at|date:"M d, Y" }}
          </p>

          {% if blog.caption %}
          <p class="text-muted fst-italic">üß† Caption: "{{ blog.caption }}"</p>
          {% endif %}

          {% if blog.hashtags %}
          <p>
            {% for tag in blog.hashtags|split %}
  <span class="badge bg-primary">#{{ tag }}</span>
{% endfor %}
          </p>
          {% endif %}

          <p class="card-text">{{ blog.content|truncatewords:30 }}</p>

          {% if user.is_authenticated %}
          <div class="mb-2">
            <button type="button"
                    id="like-btn-{{ blog.id }}"
                    onclick="toggleLike({{ blog.id }})"
                    class="btn btn-outline-primary btn-sm">
              {% if user_likes|dict_key:blog.id %}
                üíî Unlike
              {% else %}
                ‚ù§Ô∏è Like
              {% endif %}
            </button>
            <span id="like-count-{{ blog.id }}">({{ blog.likes.count }})</span>
          </div>

          <!-- Comment Form -->
          <form method="post" action="{% url 'add-blog-comment' blog.id %}" class="mb-2">
            {% csrf_token %}
            <textarea name="comment" class="form-control mb-2" rows="2" placeholder="Add a comment..."></textarea>
            <button type="submit" class="btn btn-outline-secondary btn-sm">üí¨ Comment</button>
          </form>
          {% else %}
          <p class="text-muted">Login to like or comment.</p>
          {% endif %}

          <!-- Comments -->
          {% if blog.comments.exists %}
          <div class="mt-3">
            <h6 class="text-muted">Comments:</h6>
            {% for comment in blog.comments.all %}
            <div class="border rounded p-2 mb-2 d-flex justify-content-between align-items-start">
              <div>
                <strong>{{ comment.user }}</strong>
                <small class="text-muted d-block">{{ comment.created_at|date:"M d, Y H:i" }}</small>
                <p class="mb-0">{{ comment.comment }}</p>
              </div>
              {% if user.is_authenticated and user.profile == comment.user %}
              <form method="post" action="{% url 'delete-blog-comment' comment.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-outline-danger ms-2">üóëÔ∏è</button>
              </form>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="alert alert-info text-center">No blog posts yet. Be the first to share your story!</div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
function toggleLike(blogId) {
    fetch(`/blogs/like/${blogId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCSRFToken(),
            'X-Requested-With': 'XMLHttpRequest'
        },
    })
    .then(response => {
        if (!response.ok) throw new Error('Network error');
        return response.json();
    })
    .then(data => {
        const likeBtn = document.getElementById(`like-btn-${blogId}`);
        const likeCount = document.getElementById(`like-count-${blogId}`);
        likeBtn.innerText = data.liked ? 'üíî Unlike' : '‚ù§Ô∏è Like';
        likeCount.innerText = `(${data.total_likes})`;
    })
    .catch(err => console.error('AJAX like failed:', err));
}

function getCSRFToken() {
    const name = 'csrftoken';
    return document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1];
}
</script>
{% endblock %}
