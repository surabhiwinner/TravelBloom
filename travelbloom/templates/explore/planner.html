{% extends "base.html" %}
{% load static %}

{% block section %}
<div class="container py-5">
  <h2 class="text-center mb-5 display-6 text-primary">üß≠ Smart Trip Planner</h2>

  <!-- üîç City Search -->
  <div class="input-group mb-4 shadow-sm">
    <input id="city-search" class="form-control form-control-lg" placeholder="Enter a city‚Ä¶" autocomplete="off">
    <button id="search-btn" class="btn btn-primary btn-lg px-4">Search</button>
  </div>

  <!-- üìå Columns for Places -->
  <div class="row g-4">
    <div class="col-md-6">
      <h4 class="text-info">üìç Attractions</h4>
      <div id="attractions" class="list-group shadow-sm" style="max-height: 500px; overflow-y: auto;"></div>
    </div>

    <div class="col-md-6">
      <h4 class="text-success">üè® Hotels</h4>
      <div id="hotels" class="list-group shadow-sm" style="max-height: 500px; overflow-y: auto;"></div>
    </div>
  </div>
</div>

<!-- üöó Buttons -->
<div class="text-center my-4">
  <button id="route-btn" class="btn btn-success btn-lg" disabled>
    <span class="spinner-border spinner-border-sm d-none"></span>
    <span class="btn-text">üöó Build Smart Route</span>
  </button>
  <button id="save-trip-btn" class="btn btn-outline-primary ms-3" disabled>üíæ Save This Trip</button>
</div>

<!-- üó∫Ô∏è Map & List -->
<div id="route-map" class="d-none rounded shadow-sm mb-4" style="height: 400px;"></div>
<div class="selected-places"></div>

<!-- Styles -->
<style>
  .list-group-item { border: none; border-bottom: 1px solid #eee; transition: background .2s; }
  .list-group-item:hover { background: #f9f9f9; }
  .list-group-item img { border-radius: 8px; width: 80px; object-fit: cover; }
  #route-btn { position: relative; min-width: 230px; }
  #route-btn[disabled] { opacity: 0.7; pointer-events: none; }
  .spinner-border { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); }
</style>

<!-- ‚úÖ JavaScript -->
<script>
let allPlaces = [];
const selected = new Set();
let selectedCity = null;
let selectedLat = null;
let selectedLng = null;

async function loadPlaces(city, kind, lat = null, lng = null) {
  const box = kind === "hotel" ? "#hotels" : kind === "attraction" ? "#attractions" : null;
  if (!box) return;
  const container = document.querySelector(box);
  if (!container.dataset.loaded) {
    container.innerHTML = "Loading‚Ä¶";
    container.dataset.loaded = "yes";
  }

  const res = await fetch("{% url 'fetch_places' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ city, kind, lat, lng })
  }).then(r => r.json());

  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const currIndex = container.querySelectorAll("label.list-group-item").length;

  res.results
    .filter(p =>
      kind !== "hotel" || (
        p.types &&
        (
          p.types.includes("lodging") ||
          p.name.toLowerCase().includes("hotel") ||
          p.name.toLowerCase().includes("resort") ||
          p.name.toLowerCase().includes("homestay")
        )
      )
    )
    .slice(0, kind === "hotel" ? 10 : res.results.length)
    .forEach((p, i) => {
      p.kind = kind;
      allPlaces.push(p);
      const code = letters[(currIndex + i) % 26];
      const img = p.photos?.[0]?.photo_reference
        ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=200&photo_reference=${p.photos[0].photo_reference}&key={{ GOOGLE_MAPS_API_KEY }}`
        : "https://via.placeholder.com/200x100";

      const html = `
        <label class="list-group-item d-flex gap-3 align-items-start">
          <input type="checkbox" value="${p.place_id}" class="form-check-input place-box flex-shrink-0" data-kind="${p.kind}">
          <img src="${img}" class="rounded" style="width: 80px; height: 60px; object-fit: cover;">
          <span><strong class="me-2 text-primary">(${code})</strong><strong>${p.name}</strong><br><small>${p.formatted_address || p.vicinity}</small></span>
        </label>`;
      container.insertAdjacentHTML("beforeend", html);
    });

  container.innerHTML = container.innerHTML.replace("Loading‚Ä¶", "");

  document.querySelectorAll(".place-box").forEach(cb => {
    cb.onchange = () => {
      cb.checked ? selected.add(cb.value) : selected.delete(cb.value);
    };
  });
}

function doSearch(city, lat = null, lng = null) {
  document.querySelector("#hotels").innerHTML = "";
  document.querySelector("#attractions").innerHTML = "";
  document.querySelector("#hotels").removeAttribute("data-loaded");
  document.querySelector("#attractions").removeAttribute("data-loaded");

  loadPlaces(city, "hotel", lat, lng);
  loadPlaces(city, "attraction", lat, lng);
}

function initAutocomplete() {
  const cityInput = document.getElementById("city-search");
  const autocomplete = new google.maps.places.Autocomplete(cityInput, { types: ["(cities)"] });

  autocomplete.addListener("place_changed", () => {
    const place = autocomplete.getPlace();
    if (!place.geometry) return;

    selectedCity = place.name;
    selectedLat = place.geometry.location.lat();
    selectedLng = place.geometry.location.lng();

    doSearch(selectedCity, selectedLat, selectedLng);
  });

  cityInput.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      if (selectedCity) {
        doSearch(selectedCity, selectedLat, selectedLng);
      } else {
        const rawCity = this.value.trim();
        if (rawCity) doSearch(rawCity);
      }
    }
  });

  document.getElementById("search-btn").addEventListener("click", () => {
    const rawCity = cityInput.value.trim();
    if (selectedCity && rawCity === selectedCity && selectedLat && selectedLng) {
      doSearch(selectedCity, selectedLat, selectedLng);
    } else if (rawCity) {
      doSearch(rawCity);
    }
  });
}
</script>

<!-- Google Maps API -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_API_KEY }}&libraries=places&callback=initAutocomplete">
</script>

{% endblock %}
