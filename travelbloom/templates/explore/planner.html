{% extends "base.html" %}
{% block section %}
<div class="container my-4">
  <h2 class="mb-3">Trip Planner</h2>

  <!-- 🔎 Search -->
  <div class="input-group mb-4">
    <input id="city-input" class="form-control" placeholder="Enter a city (e.g. Jaipur)">
    <button id="search-btn" class="btn btn-primary">Search</button>
  </div>

  <div class="row">
    <div class="col-lg-6">
      <h4>Must Visit</h4>
      <div id="attractions" class="list-group small"></div>
    </div>
    <div class="col-lg-6">
      <h4>Hotels</h4>
      <div id="hotels" class="list-group small"></div>
    </div>
  </div>

  <button id="route-btn" class="btn btn-success mt-4" disabled>Build Route</button>

  <!-- 🗺️ Route Map -->
  <div id="route-map" class="mt-4 d-none" style="height:400px"></div>
</div>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>

<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<!-- Google Maps JS v=beta -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key={{GOOGLE_MAPS_API_KEY}}
  &libraries=places,marker&v=beta&callback=initPlanner"></script>

<script>
/* ---------- Globals ---------- */
let selected = new Set();          // chosen place_id’s
let map, dirSrv, dirRend;

/* ---------- 1. Load Google API callback ---------- */
function initPlanner() {
  document.getElementById("search-btn").onclick = doSearch;
  document.getElementById("route-btn").onclick  = buildRoute;
}

/* ---------- 2. Search city ---------- */
async function doSearch() {
  const city = document.getElementById("city-input").value.trim();
  if (!city) return;
  selected.clear();
  document.getElementById("route-btn").disabled = true;
  await loadPlaces(city, "attraction");
  await loadPlaces(city, "hotel");
}

async function loadPlaces(city, kind) {
  const box = kind === "attraction" ? "#attractions" : "#hotels";
  document.querySelector(box).innerHTML = "Loading…";

  const res = await fetch("{% url 'fetch_places' %}", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ city, kind })
  }).then(r => r.json());

  const html = res.results.map(p => cardHTML(p)).join("");
  document.querySelector(box).innerHTML = html || "<em>No results</em>";
  attachCheckboxEvents();
}

function cardHTML(p) {
  const photoRef = p.photos?.[0]?.photo_reference;
  const img = photoRef
    ? `https://maps.googleapis.com/maps/api/place/photo?maxwidth=400&photo_reference=${photoRef}&key={{GOOGLE_MAPS_API_KEY}}`
    : "https://via.placeholder.com/400x200";

  return `
  <label class="list-group-item d-flex gap-3">
    <input type="checkbox" value="${p.place_id}"
           class="form-check-input place-box flex-shrink-0">
    <img src="${img}" style="width:80px;object-fit:cover">
    <span>
      <strong>${p.name}</strong><br>
      <small>${p.formatted_address}</small>
    </span>
  </label>`;
}

function attachCheckboxEvents() {
  document.querySelectorAll(".place-box").forEach(cb => {
    cb.onchange = () => {
      cb.checked ? selected.add(cb.value) : selected.delete(cb.value);
      document.getElementById("route-btn").disabled = selected.size < 2;
    };
  });
}

/* ---------- 3. Build Route ---------- */
function buildRoute() {
  if (selected.size < 2) return;
  document.getElementById("route-map").classList.remove("d-none");

  const ids = [...selected];               // origin … destination
  if (!dirSrv) dirSrv = new google.maps.DirectionsService();
  if (!dirRend) dirRend = new google.maps.DirectionsRenderer({ suppressMarkers: false });

  map = new google.maps.Map(document.getElementById("route-map"), {
    zoom: 5, center: { lat: 22, lng: 80 }
  });
  dirRend.setMap(map);

  const waypts = ids.slice(1, -1).map(id => ({
    location: { placeId: id }, stopover: true
  }));

  dirSrv.route(
    {
      origin:      { placeId: ids[0] },
      destination: { placeId: ids[ids.length - 1] },
      waypoints:   waypts,
      travelMode:  google.maps.TravelMode.DRIVING
    },
    (res, status) => {
      if (status === "OK") dirRend.setDirections(res);
      else alert("Directions error: " + status);
    }
  );
}
</script>
{% endblock %}
